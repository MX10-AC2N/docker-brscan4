name: ğŸ¤– Auto-update Brother drivers (monthly)

on:
  schedule:
    - cron: '0 5 1 * *'    # 1er du mois Ã  05:00 UTC
  workflow_dispatch:        # Lancement manuel possible

jobs:
  check-and-update:
    runs-on: ubuntu-24.04

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“– Lecture des versions actuelles
        id: current
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ“– Versions actuellement en repo"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          BRSCAN4_CURRENT=$(cat BRSCAN4_VERSION 2>/dev/null | tr -d '[:space:]' || echo "0.0.0-0")
          echo "  ğŸ“¦ brscan4     : ${BRSCAN4_CURRENT}"

          SKEY_CURRENT=$(ls drivers/brscan-skey-*.deb 2>/dev/null | grep -oP 'brscan-skey-\K[\d.]+-\d+' | head -1 || echo "0.0.0-0")
          echo "  ğŸ“¦ brscan-skey : ${SKEY_CURRENT}"

          UDEV_CURRENT=$(ls drivers/brother-udev-rule-type1-*.deb 2>/dev/null | grep -oP 'type1-\K[\d.]+-\d+' | head -1 || echo "0.0.0-0")
          echo "  ğŸ“¦ udev-rule   : ${UDEV_CURRENT}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          echo "brscan4_current=${BRSCAN4_CURRENT}"   >> $GITHUB_OUTPUT
          echo "skey_current=${SKEY_CURRENT}"         >> $GITHUB_OUTPUT
          echo "udev_current=${UDEV_CURRENT}"         >> $GITHUB_OUTPUT

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # brscan4 : dÃ©tecte la version disponible sur les serveurs Brother
      # On teste plusieurs numÃ©ros de miroir connus (dlf105200, 201, 203)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” DÃ©tection de la derniÃ¨re version brscan4
        id: detect_brscan4
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ” Recherche de la derniÃ¨re version brscan4..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          MIRRORS=(dlf105200 dlf105201 dlf105203)
          # Versions connues Ã  tester (du plus rÃ©cent au plus ancien)
          VERSIONS=(0.4.11-1 0.4.10-1 0.4.9-1)

          FOUND_VERSION=""
          FOUND_URL=""

          for VERSION in "${VERSIONS[@]}"; do
            for MIRROR in "${MIRRORS[@]}"; do
              URL="https://download.brother.com/welcome/${MIRROR}/brscan4-${VERSION}.amd64.deb"
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${URL}")
              if [ "${HTTP_CODE}" = "200" ]; then
                FOUND_VERSION="${VERSION}"
                FOUND_URL="${URL}"
                echo "  âœ… TrouvÃ© : brscan4-${VERSION} â†’ ${URL}"
                break 2
              fi
            done
          done

          if [ -z "${FOUND_VERSION}" ]; then
            echo "  âš ï¸  Aucune version brscan4 accessible â€” serveurs Brother injoignables ?"
          else
            echo "  ğŸ“¦ DerniÃ¨re version disponible : ${FOUND_VERSION}"
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          echo "brscan4_latest=${FOUND_VERSION}"  >> $GITHUB_OUTPUT
          echo "brscan4_url=${FOUND_URL}"         >> $GITHUB_OUTPUT

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # brscan-skey : mÃªme logique
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” DÃ©tection de la derniÃ¨re version brscan-skey
        id: detect_skey
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ” Recherche de la derniÃ¨re version brscan-skey..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          VERSIONS=(0.3.4-0 0.3.3-0 0.3.2-0)
          MIRRORS=(dlf006652 dlf006653)

          FOUND_VERSION=""
          FOUND_URL=""

          for VERSION in "${VERSIONS[@]}"; do
            for MIRROR in "${MIRRORS[@]}"; do
              URL="https://download.brother.com/welcome/${MIRROR}/brscan-skey-${VERSION}.amd64.deb"
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${URL}")
              if [ "${HTTP_CODE}" = "200" ]; then
                FOUND_VERSION="${VERSION}"
                FOUND_URL="${URL}"
                echo "  âœ… TrouvÃ© : brscan-skey-${VERSION} â†’ ${URL}"
                break 2
              fi
            done
          done

          if [ -z "${FOUND_VERSION}" ]; then
            echo "  âš ï¸  Aucune version brscan-skey accessible."
          else
            echo "  ğŸ“¦ DerniÃ¨re version disponible : ${FOUND_VERSION}"
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          echo "skey_latest=${FOUND_VERSION}"  >> $GITHUB_OUTPUT
          echo "skey_url=${FOUND_URL}"         >> $GITHUB_OUTPUT

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # TÃ©lÃ©chargement des .deb si nouvelle version dÃ©tectÃ©e
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Mise Ã  jour des drivers si nÃ©cessaire
        id: download
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ“¥ VÃ©rification des mises Ã  jour"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          UPDATED=false

          # --- brscan4 ---
          BRSCAN4_LATEST="${{ steps.detect_brscan4.outputs.brscan4_latest }}"
          BRSCAN4_CURRENT="${{ steps.current.outputs.brscan4_current }}"

          if [ -n "${BRSCAN4_LATEST}" ] && [ "${BRSCAN4_LATEST}" != "${BRSCAN4_CURRENT}" ]; then
            echo "  ğŸ†• brscan4 : ${BRSCAN4_CURRENT} â†’ ${BRSCAN4_LATEST}"
            rm -f drivers/brscan4-*.deb
            curl -fSL -o "drivers/brscan4-${BRSCAN4_LATEST}.amd64.deb" \
                "${{ steps.detect_brscan4.outputs.brscan4_url }}"
            echo "${BRSCAN4_LATEST}" > BRSCAN4_VERSION
            echo "  âœ… brscan4 mis Ã  jour"
            UPDATED=true
          else
            echo "  âœ”ï¸  brscan4 dÃ©jÃ  Ã  jour (${BRSCAN4_CURRENT})"
          fi

          # --- brscan-skey ---
          SKEY_LATEST="${{ steps.detect_skey.outputs.skey_latest }}"
          SKEY_CURRENT="${{ steps.current.outputs.skey_current }}"

          if [ -n "${SKEY_LATEST}" ] && [ "${SKEY_LATEST}" != "${SKEY_CURRENT}" ]; then
            echo "  ğŸ†• brscan-skey : ${SKEY_CURRENT} â†’ ${SKEY_LATEST}"
            rm -f drivers/brscan-skey-*.deb
            curl -fSL -o "drivers/brscan-skey-${SKEY_LATEST}.amd64.deb" \
                "${{ steps.detect_skey.outputs.skey_url }}"
            echo "  âœ… brscan-skey mis Ã  jour"
            UPDATED=true
          else
            echo "  âœ”ï¸  brscan-skey dÃ©jÃ  Ã  jour (${SKEY_CURRENT})"
          fi

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "updated=${UPDATED}" >> $GITHUB_OUTPUT

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Commit + tag + push si au moins un driver a changÃ©
      # DÃ©clenche ensuite automatiquement le build-and-push
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ’¾ Commit, tag et push si mis Ã  jour
        if: steps.download.outputs.updated == 'true'
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add drivers/ BRSCAN4_VERSION

          BRSCAN4_LATEST="${{ steps.detect_brscan4.outputs.brscan4_latest }}"
          git commit -m "chore: ğŸ¤– auto-update drivers â†’ brscan4 ${BRSCAN4_LATEST} [skip ci]"

          TAG="v${BRSCAN4_LATEST}"
          # Ã‰vite les doublons de tag
          git tag "${TAG}" 2>/dev/null || echo "  âš ï¸  Tag ${TAG} existe dÃ©jÃ , ignorÃ©."

          git push origin HEAD:${{ github.ref_name || 'master' }}
          git push origin "${TAG}" 2>/dev/null || true

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âœ… Commit + tag ${TAG} poussÃ©s"
          echo "  â„¹ï¸  Le workflow build-and-push doit"
          echo "     Ãªtre relancÃ© manuellement si besoin"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: âœ”ï¸ Aucune mise Ã  jour nÃ©cessaire
        if: steps.download.outputs.updated != 'true'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âœ”ï¸  Tous les drivers sont dÃ©jÃ  Ã  jour"
          echo "  â„¹ï¸  Aucun commit effectuÃ©."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
