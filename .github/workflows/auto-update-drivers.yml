name: ü§ñAuto-update Brother drivers .deb files (monthly)

on:
  schedule:
    - cron: '0 5 1 * *'          # 1er du mois √† 05:00 UTC
  workflow_dispatch:             # Lancement manuel depuis l'interface

jobs:
  check-and-update:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install required tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y curl dpkg grep sed coreutils

      - name: List .deb files in drivers/
        id: list-debs
        run: |
          DEBS=$(ls -1 drivers/*.deb 2>/dev/null || true)
          if [ -z "$DEBS" ]; then
            echo "Aucun fichier .deb trouv√© dans drivers/"
          else
            echo "Fichiers trouv√©s :"
            echo "$DEBS"
          fi
          # Sauvegarde multi-ligne safe pour GitHub Actions
          echo "debs<<EOF" >> $GITHUB_OUTPUT
          echo "$DEBS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check for newer versions and update .deb files
        id: update
        run: |
          UPDATED=false

          echo "${{ steps.list-debs.outputs.debs }}" | while IFS= read -r deb_file; do
            if [ -z "$deb_file" ] || [ ! -f "$deb_file" ]; then
              continue
            fi

            echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
            echo "Traitement : $deb_file"

            # Extraction fiable via dpkg-deb
            pkg_name=\( (dpkg-deb --show --showformat=' \){Package}' "$deb_file" 2>/dev/null || basename "$deb_file" | sed 's/-.*//')
            current_version=\( (dpkg-deb --show --showformat=' \){Version}' "$deb_file" 2>/dev/null || echo "unknown")
            arch=\( (dpkg-deb --show --showformat=' \){Architecture}' "$deb_file" 2>/dev/null || basename "$deb_file" | grep -oE '(amd64|all|i386)' || echo "amd64")

            if [ "$current_version" = "unknown" ]; then
              echo "  √âchec extraction version avec dpkg-deb ‚Üí skip ce fichier"
              continue
            fi

            echo "  Paquet d√©tect√©     : $pkg_name"
            echo "  Version actuelle   : $current_version"
            echo "  Architecture       : $arch"

            latest_version=""
            latest_url=""

            # Configuration par type de driver
            case "$pkg_name" in
              brscan4)
                base_urls=(
                  "https://download.brother.com/welcome/dlf105200/"
                  "https://download.brother.com/welcome/dlf105203/"
                  "https://download.brother.com/welcome/dlf006645/"
                )
                candidates=("0.4.11-1" "0.4.12-1" "0.4.13-1" "0.5.0-1" "0.5.1-1")
                filename_pattern="brscan4-%s.${arch}.deb"
                ;;
              brscan-skey)
                base_urls=(
                  "https://download.brother.com/welcome/dlf006652/"
                  "https://download.brother.com/welcome/dlf105204/"
                )
                candidates=("0.3.1-2" "0.3.2-0" "0.3.3-0" "0.3.4-0" "0.3.5-0")
                filename_pattern="brscan-skey-%s.${arch}.deb"
                ;;
              brother-udev-rule-type1)
                base_urls=(
                  "https://download.brother.com/welcome/dlf006893/"
                  "https://download.brother.com/welcome/dlf006894/"
                )
                candidates=("1.0.2-0" "1.0.3-0" "1.1.0-0")
                filename_pattern="brother-udev-rule-type1-%s.${arch}.deb"
                ;;
              *)
                echo "  ‚Üí Type de driver non g√©r√© dans le case ‚Üí skip"
                continue
                ;;
            esac

            # Recherche de la version la plus r√©cente disponible
            for candidate in "${candidates[@]}"; do
              for base_url in "${base_urls[@]}"; do
                candidate_url="\( {base_url} \)(printf "$filename_pattern" "$candidate")"
                http_code=$(curl -s -o /dev/null -w "%{http_code}" "$candidate_url")
                if [ "$http_code" = "200" ]; then
                  if [ "$candidate" != "$current_version" ]; then
                    latest_version="$candidate"
                    latest_url="$candidate_url"
                    echo "  ‚Üí Version plus r√©cente trouv√©e : $latest_version"
                    echo "     URL : $latest_url"
                    break 2
                  else
                    echo "  ‚Üí Version actuelle d√©j√† la plus r√©cente ($current_version)"
                    break 2
                  fi
                fi
              done
            done

            # Mise √† jour si trouv√©
            if [ -n "$latest_version" ]; then
              cd drivers
              old_filename=$(basename "$deb_file")
              rm -f "$old_filename"
              echo "  ‚Üí T√©l√©chargement : $latest_url"
              curl -fSL -O "$latest_url" || { echo "√âchec du t√©l√©chargement ‚Üí abandon"; exit 1; }
              cd ..
              UPDATED=true
              echo "  ‚Üí Mise √† jour effectu√©e : $old_filename ‚Üí $(basename "$latest_url")"
            else
              echo "  ‚Üí Aucune version plus r√©cente d√©tect√©e"
            fi
          done

          echo "updated=$UPDATED" >> $GITHUB_OUTPUT

      - name: Commit changes, create tag and push (if updated)
        if: steps.update.outputs.updated == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add drivers/*.deb
          git commit -m "chore: auto-update Brother .deb drivers (newer versions found)"

          # Cr√©ation d'un tag dat√©
          TAG_NAME="driver-update-$(date +%Y%m%d-%H%M%S)"
          git tag "$TAG_NAME"

          git push origin HEAD:${{ github.ref_name || 'master' }}
          git push origin --tags

          echo "Mises √† jour committ√©es et tag $TAG_NAME cr√©√©/pouss√©."