name: ü§ñ‚ÄØAuto-update brscan4 version (monthly check)

on:
  schedule:
    - cron: '0 5 1 * *'          # 1er du mois √† 05:00 UTC ‚Üí une fois par mois
  workflow_dispatch:             # Lancement manuel possible

jobs:
  check-and-update:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install required tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y curl grep sed coreutils

      - name: Read current version from BRSCAN4_VERSION
        id: current
        run: |
          if [ -f BRSCAN4_VERSION ]; then
            CURRENT_VERSION=$(cat BRSCAN4_VERSION | tr -d '[:space:]')
          else
            CURRENT_VERSION="0.0.0"
          fi
          echo "current_version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
          echo "Version actuelle : ${CURRENT_VERSION}"

      - name: Detect latest available brscan4 version
        id: detect
        run: |
          # URLs connues pour brscan4 amd64 deb (ajoute si tu en trouves d'autres)
          URLS=(
            "https://download.brother.com/welcome/dlf105200/brscan4-0.4.11-1.amd64.deb"
            "https://download.brother.com/welcome/dlf105203/brscan4-0.4.11-1.amd64.deb"
            "https://download.brother.com/welcome/dlf105201/brscan4-0.4.11-1.amd64.deb"
          )

          LATEST_VERSION=""
          LATEST_URL=""

          for url in "${URLS[@]}"; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$url")
            if [ "$HTTP_CODE" = "200" ]; then
              VERSION=$(echo "$url" | grep -oP 'brscan4-\K[\d.]+(?=-[0-9]+\.amd64\.deb)')
              if [ -n "$VERSION" ]; then
                LATEST_VERSION="$VERSION"
                LATEST_URL="$url"
                echo "Version trouv√©e : $VERSION via $url"
                break
              fi
            fi
          done

          if [ -z "$LATEST_VERSION" ]; then
            echo "Aucune version valide trouv√©e."
            echo "latest_version=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "latest_url=$LATEST_URL" >> $GITHUB_OUTPUT

      - name: Update version file if newer
        if: steps.detect.outputs.latest_version != '' && steps.detect.outputs.latest_version != steps.current.outputs.current_version
        run: |
          echo "Nouvelle version d√©tect√©e ! Ancienne: ${{ steps.current.outputs.current_version }} ‚Üí Nouvelle: ${{ steps.detect.outputs.latest_version }}"
          echo "${{ steps.detect.outputs.latest_version }}" > BRSCAN4_VERSION

      - name: Commit, tag and push if updated
        if: steps.detect.outputs.latest_version != '' && steps.detect.outputs.latest_version != steps.current.outputs.current_version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add BRSCAN4_VERSION
          git commit -m "chore: update brscan4 to ${{ steps.detect.outputs.latest_version }} (auto-detected)"

          # Cr√©ation du tag Git (ex. v0.4.12 si version=0.4.12)
          git tag "v${{ steps.detect.outputs.latest_version }}"

          git push origin HEAD:${{ github.ref_name || 'master' }}
          git push origin "v${{ steps.detect.outputs.latest_version }}"

          echo "Commit + tag v${{ steps.detect.outputs.latest_version }} pouss√©s."